version: '3.7'

services:
  openvpn:
    image: lawtancool/docker-openvpn-xor@sha256:5c4169cb95e63b73c661c5e31dd7e85e55a7083f246953011864e817f3481846
    restart: unless-stopped
    volumes:
      - "./resolv.conf:/etc/netns/route/resolv.conf"
      - "./vpn:/etc/openvpn:ro"
      - "./scripts:/opt/scripts:ro"
      - "./rr:/var/rr:rw"
    pid: "service:route"
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    devices:
      - "/dev/net/tun"
    command: ["/opt/scripts/ovpn-run.sh", "--up-restart"]
  route:
    build: build/iptables
    restart: unless-stopped
    init: true
    stop_signal: SIGKILL
    volumes:
      - "./resolv.conf:/etc/resolv.conf"
      - "./wireguardserver/config:/etc/wireguard:ro"
    cap_add:
      - NET_ADMIN
    network_mode: none
    sysctls:
      - "net.ipv4.ping_group_range=0 2147483647"
      - "net.ipv4.ip_forward=1"
    command: ["sh", "-c", "iptables -t nat -A POSTROUTING -j MASQUERADE &&
                           iptables -A FORWARD -s $(cat /etc/wireguard/address) \
                                               -d $(cat /etc/wireguard/address) -j REJECT &&
                           iptables -A OUTPUT -m owner --uid-owner 17818 \
                                               -d $(cat /etc/wireguard/address) -j REJECT &&
                           iptables -A FORWARD -j ACCEPT &&
                           iptables -t mangle -A FORWARD -j TTL --ttl-inc 1 &&
                           exec tail -f /dev/null"]
  wireguardserver:
    build: build/wireguardserver
    restart: unless-stopped
    volumes:
      - "./wireguardserver/config:/etc/wireguard:ro"
      - "./wireguardserver/scripts:/opt/scripts:ro"
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    pid: "service:route"
    network_mode: host
    command: ["/opt/scripts/wgserver-run.sh"]
  dnsmasq:
    build: build/dnsmasq
    restart: unless-stopped
    stop_signal: SIGKILL
    network_mode: "service:route"
    command: --no-hosts --cache-size=0 --strict-order --clear-on-reload
  socks5:
    image: ghcr.io/wzshiming/socks5/socks5:v0.4.2@sha256:1aca1fa75fc2ebd0041ca6944627f48223541cf37e03722b2982e7f6c23af2c6
    restart: unless-stopped
    network_mode: "service:route"
    user: "17818"
  socat2unix:
    image: alpine/socat:1.7.4.4@sha256:93efcf633c5489b170404df25e289f811cabeea728a5367f0c9b1560982edf14
    restart: unless-stopped
    volumes:
      - "./sock:/var/sock:rw"
    network_mode: "service:route"
    command: ["unix-listen:/var/sock/socks5,fork,unlink-early", "tcp-connect:127.0.0.1:1080"]
  socat2port:
    image: alpine/socat:1.7.4.4@sha256:93efcf633c5489b170404df25e289f811cabeea728a5367f0c9b1560982edf14
    restart: unless-stopped
    volumes:
      - "./sock:/var/sock:ro"
    ports:
      - "1080:1080"
    command: ["tcp-listen:1080,fork", "unix-connect:/var/sock/socks5"]
